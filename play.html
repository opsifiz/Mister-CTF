<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mister CTF</title>
    <link rel="stylesheet" href="./assets/style.css">
    <link rel="icon" href="favicon.ico">
</head>
<body class="center">
    <section class="chall">
        <div class="title center" style="margin: 25px 25px">
            <h1>
                Mister - CTF!!
            </h1>
            <p class="subtitle">
                Capture the FlagðŸš© With MisterO
            </p>
        </div>
        <hr style="width: min(1000px, 90%);">
        <section class="stages"></section>
        <section class="extras"></section>
    </section>
    <script>
        let id = new URLSearchParams(document.location.search).get("stage");
        if(id == null){
            // Append Lobby
            fetch('content/data.json')
            .then(response => response.json())
            .then(res=>{
                for(let id=1;id<=10;id++){
                    let data = res[id];
                    let stage = document.createElement("a");
                    stage.classList.add("stage");
                    if(window.localStorage.getItem(`stage-${id}`) != null && CryptoJS.SHA1(window.localStorage.getItem(`stage-${id}`)).toString() == data.key){
                        stage.classList.add("passed");
                    }
                    stage.href = `?stage=${id}`;
                    stage.innerHTML = `Stage ${id}<hr class="underline">${data.name}`;

                    // stages.appendChild(stage);
                    document.querySelector("section.stages").appendChild(stage);
                }
            });
        }
        fetch('content/data.json')
        .then(response => response.json())
        .then(res => {
            if(id != null && (1 > Number(id) || Number(id) > 10)) window.location.href = "https://www.youtube.com/watch?v=itJ_DJVKAW0";
            if(id != null){
                let require = 0;
                if (Array.isArray(res[id]["require"])) {
                    res[id]["require"].forEach(idx => {
                        if(CryptoJS.SHA1(window.localStorage.getItem(`stage-${idx}`)).toString() != res[idx]["key"]){
                            alert(`Please do Stage-${idx} to unlock this stage!`);
                            window.location.href = "play.html";
                            require = 1;
                            return;
                        }
                    });
                }
                if(require) return;
                res = res[id];
                
                document.querySelector("section.chall").classList.add("center");

                let div = document.createElement("div");
                
                // console.log("Name : ", res.name);
                let name = document.createElement("p");
                name.innerHTML = `Name : ${res.name}`;
                div.appendChild(name);
                
                // console.log("Challenge : ", res.challenge);
                let challenge = document.createElement("p");
                challenge.innerHTML = `Challenge : ${res.challenge}`;
                div.appendChild(challenge);
                
                if(res.files != null){
                    let list = document.createElement("div");
                    res.files.forEach(file => {
                        let container = document.createElement("div");
                        container.classList.add("file");
                        // console.log("File : ",file)
                        let a = document.createElement("a");
                        a.href = `content/${id}/${file}`;
                        a.innerText = `${file}`;
                        container.appendChild(a);
                        list.appendChild(container);
                    });
                    div.appendChild(list);
                }
                // console.log(res);
                // console.log("Preview : ",res.hints);
                if(res.hints != null){
                    let list = document.createElement("div");
                    let cnt = 1;
                    res.hints.forEach((_, index) => {
                        let container = document.createElement("div");
                        container.classList.add("file");
                        let btn = document.createElement("button");
                        btn.innerText = `Hint #${index+1}`;
                        btn.onclick = () => hint(index);
                        cnt += 1;
                        container.appendChild(btn);
                        list.appendChild(container);
                    });
                    div.appendChild(list);
                }
        
                let input = document.createElement("input");
                input.type="text";
                input.autocomplete = "off";
                input.id = `ans-${id}`;
                div.appendChild(input);
                
                let submit = document.createElement("button");
                submit.innerText = "Submit!!"
                submit.onclick = () => judge(id);
                div.appendChild(submit);
                
                document.querySelector("section.chall").append(div);
            }else{
                let flag = 1;
                for(let i=1;i<=10;i++){
                    if(window.localStorage.getItem(`stage-${i}`) === null || CryptoJS.SHA1(window.localStorage.getItem(`stage-${i}`)).toString()  != res[i]['key']){
                        flag = 0;
                        console.log("break = ", i);
                        break;
                    }
                }
                if(flag /*|| 1*/){
                    let extra = document.createElement("div");
                    extra.classList.add("center");
                    extra.innerHTML = `<a href="?stage=extra" class="extra">Extra Stage #1<hr class="underline">${res["extra1"]["name"]}</a>`;
                    // extra.innerHTML += `Stage ${id}`;
                    document.querySelector("section.extras").appendChild(extra);
                }
            }
        })
        .catch(error => {
            console.error("Error loading JSON:", error);
        });
    </script>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
    function judge(id){
        let ans = document.getElementById(`ans-${id}`).value;
        if(ans.trim() == "") return;
        fetch('content/data.json')
        .then(response => response.json())
        .then(res => {
            let flag = res[id].flag;
            console.log(ans);
            var hash = CryptoJS.MD5(ans);
            if(flag == hash){
                alert("Correct!!");
                alert("Get Ready for NEXT Stage!!");
                window.localStorage.setItem(`stage-${id}`, CryptoJS.SHA1(ans).toString());
                window.location.href = "play.html?stage=" + (Number(id) + 1);
            }else{
                alert("Incorrect *^*");
                document.getElementById(`ans-${id}`).value = "";
            }
        })
        .catch(error => {
            console.error("Error loading JSON:", error);
        });
    }

    function hint(cnt){
        let id = new URLSearchParams(document.location.search).get("stage");

        fetch('content/data.json')
        .then(response => response.json())
        .then(res => {
            // console.log(cnt);
            let txt = res[id]["hints"][cnt];
            alert(txt);
            return;
        })
        .catch(error => {
            console.error("Error loading JSON:", error);
        });
    }
</script>
</html>