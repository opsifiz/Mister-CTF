<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mister CTF</title>
    <link rel="stylesheet" href="./assets/style.css">
    <link rel="icon" href="favicon.ico">
</head>
<body class="center">
    <section class="chall">
        <div class="title center" style="margin: 25px 25px">
            <h1>
                Mister CTF!!
            </h1>
            <p class="subtitle">
                Capture the FlagðŸš© With MisterO
            </p>
        </div>
        <hr>
    </section>
    <script>
        let id = new URLSearchParams(document.location.search).get("stage");
        if(id == null){
            let div = document.createElement("div");
            div.innerHTML = `<div class="stages">
            <a class="stage" href="?stage=1">Stage 1</a>
            <a class="stage" href="?stage=2">Stage 2</a>
            <a class="stage" href="?stage=3">Stage 3</a>
            <a class="stage" href="?stage=4">Stage 4</a>
            <a class="stage" href="?stage=5">Stage 5</a>
            <a class="stage" href="?stage=6">Stage 6</a>
            <a class="stage" href="?stage=7">Stage 7</a>
            <a class="stage" href="?stage=8">Stage 8</a>
            <a class="stage" href="?stage=9">Stage 9</a>
            <a class="stage" href="?stage=10">Stage 10</a>
        </div>`;
            document.querySelector("section.chall").appendChild(div);
        }
        fetch('content/data.json')
        .then(response => response.json())
        .then(res => {
            if(id != null && (1 > Number(id) || Number(id) > 10)) window.location.href = "https://www.youtube.com/watch?v=itJ_DJVKAW0";
            if(id != null){
                res = res[id];
                
                document.querySelector("section.chall").classList.add("center");

                let div = document.createElement("div");
                
                console.log("Name : ", res.name);
                let name = document.createElement("p");
                name.innerText = `Name : ${res.name}`;
                div.appendChild(name);
                
                console.log("Challenge : ", res.challenge);
                let challenge = document.createElement("p");
                challenge.innerHTML = `Challenge : ${res.challenge}`;
                div.appendChild(challenge);
                
                if(res.files != null){
                    let list = document.createElement("div");
                    res.files.forEach(file => {
                        let container = document.createElement("div");
                        container.classList.add("file");
                        // console.log("File : ",file)
                        let a = document.createElement("a");
                        a.href = `content/${id}/${file}`;
                        a.innerText = `${file}`;
                        container.appendChild(a);
                        list.appendChild(container);
                    });
                    div.appendChild(list);
                }
        
                let input = document.createElement("input");
                input.type="text";
                input.autocomplete = "off";
                input.id = `ans-${id}`;
                div.appendChild(input);
                
                let submit = document.createElement("button");
                submit.innerText = "Submit!!"
                submit.onclick = () => judge(id);
                div.appendChild(submit);
                
                document.querySelector("section.chall").append(div);
            }else{
                let flag = 1;
                for(let i=1;i<=10;i++){
                    if(window.localStorage.getItem(`stage-${i}`) === null || CryptoJS.SHA1(window.localStorage.getItem(`stage-${i}`)).toString()  != res[i]['key']){
                        flag = 0;
                        console.log("break = ", i);
                        break;
                    }
                }
                if(flag){
                    let extra = document.createElement("div");
                    extra.classList.add("center");
                    extra.innerHTML = `<a href="?stage=extra" class="extra">Extra Stage</a>`;
                    document.querySelector("section.chall").appendChild(extra);
                }
            }
        })
        .catch(error => {
            console.error("Error loading JSON:", error);
        });
    </script>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
    function judge(id){
        let ans = document.getElementById(`ans-${id}`).value;
        if(ans.trim() == "") return;
        fetch('content/data.json')
        .then(response => response.json())
        .then(res => {
            let flag = res[id].flag;
            console.log(ans);
            var hash = CryptoJS.MD5(ans);
            if(flag == hash){
                alert("Correct!!");
                alert("Get Ready for NEXT Stage!!");
                window.localStorage.setItem(`stage-${id}`, CryptoJS.SHA1(ans).toString());
                window.location.href = "play.html?stage=" + (Number(id) + 1);
            }else{
                alert("Incorrect *^*");
                document.getElementById(`ans-${id}`).value = "";
            }
        })
        .catch(error => {
            console.error("Error loading JSON:", error);
        });
    }
</script>
</html>